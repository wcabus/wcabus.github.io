---
layout: post
title: 'CSP: we''re not there, yet.'
date: 2015-10-27 22:00:27.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- ASP.NET
- ASP.NET MVC
- Security
tags: []
meta:
  _edit_last: '1'
  _publicize_twitter_user: "@WesleyCabus"
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1512786163;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:512;}i:1;a:1:{s:2:"id";i:71;}i:2;a:1:{s:2:"id";i:548;}}}}
  _wpas_done_all: '1'
  _wpas_skip_3127631: '1'
  _wpas_skip_12699179: '1'
author:
  login: Wesley
  email: wesley@gotsharp.be
  display_name: Wesley
  first_name: ''
  last_name: ''
---
<p>CSP, or Content Security Policy, is an added layer of security that helps to detect and mitigate certain types of attacks, including Cross-Site Scripting (XSS) and data injection attacks. In short, you can add this policy using either a &lt;meta&gt; tag or by setting additional headers in your HTTP response, and using the policy you'll limit the origins for resources for that HTTP request. For example:</p>
<ul>
<li><span style="text-decoration: underline;"><em>script-src 'self'</em></span> allows loading scripts from the current domain</li>
<li><span style="text-decoration: underline;"><em>child-src https://youtube.com</em></span> allows the use of &lt;iframe&gt; tags pointing towards YouTube</li>
<li><em><span style="text-decoration: underline;">style-src 'self' https://maxcdn.bootstrapcdn.com</span></em> allows loading CSS files from the current source and from a CDN.</li>
</ul>
<p>If you want to read up on CSP, I suggest heading over to <a href="http://www.html5rocks.com/en/tutorials/security/content-security-policy/" target="_blank">http://www.html5rocks.com/en/tutorials/security/content-security-policy/</a></p>
<p>Now, I was trying out some things concerning CSP and inline scripts. You could add 'unsafe-inline' to the script-src source list to allow all inline scripting (except eval and other bad stuff, you need 'unsafe-eval' in that case), but that is exactly what you would want to avoid. Instead, you can opt to do one of these things:</p>
<ol>
<li>Move all inline JavaScript into .js files and load them using &lt;script src=""&gt;&lt;/script&gt; tags, while adding 'self' to script-src if that wasn't already the case. The easiest solution, but not always possible.</li>
<li>Generate a nonce for each inline script. A nonce means: a unique and hard to predict stream of bytes, different for each script, each page <strong>and</strong> each request!<br />
A nonce could be base64 encoded and look like <em>RJ6bGjm5EO/X8pImZjvjeAexFVei9IvzNFCGw5lQUa0=<br />
</em>You would need to add that nonce to the script using the nonce attribute, and also to the script-src source list using 'nonce-RJ6bGjm5EO/X8pImZjvjeAexFVei9IvzNFCGw5lQUa0='</li>
<li>Calculate the SHA256, SHA384 or SHA512 digest of each inline script (including all whitespace, but excluding the opening and closing script tags). Like the nonce, you'd need to add these digests to the script-src source list using 'sha256-0ZMofb7eMqkB9IFHnGVZ6Z4chjplAavgi09shinNehs=' for example.</li>
</ol>
<p><!--more--></p>
<p>Options 2 and 3 however are only defined in CSP v2, which is currently only implemented by Chrome, Opera and Firefox.<br />
The safest method would be to use the hash digest method, option 3. Alas, when you choose option 3, you'll quickly run into the following issues:</p>
<ul>
<li>Chrome. I'm running version 46.0.2490.80 m on a Windows PC and Chrome keeps telling me this:
<pre class="theme:classic show-lang:2 wrap:true lang:default highlight:0 decode:true">Refused to execute inline script because it violates the following Content Security Policy directive: "script-src 'self' 'sha256-0ZMofb7eMqkB9IFHnGVZ6Z4chjplAavgi09shinNehs='". Either the 'unsafe-inline' keyword, a hash ('sha256-G3FpTn2EFU91Umz2fz6NyjnqeGDTr8SUdmWbsvxzfbY='), or a nonce ('nonce-...') is required to enable inline execution.</pre>
<p>The issue? My script block contains carriage returns for readability. You know, those 'rn' thingies which tend to differ sometimes, depending on the OS you're running. But I'm running on Windows and hosting my website locally. Yet Chrome has stripped the 'r' characters from the script before calculating the SHA256 hash to verify my script block... Ugh.</li>
<li>Firefox. Version 41.0.2, catching up to Chrome apparently. Loading my test site and...
<pre class="theme:classic show-lang:2 wrap:true lang:default highlight:0 decode:true ">Content Security Policy: The page's settings blocked the loading of a resource at self ("script-src http://localhost:21275 'sha256-0ZMofb7eMqkB9IFHnGVZ6Z4chjplAavgi09shinNehs='").</pre>
</li>
<li>Edge. The newest browser from Microsoft, which I really want to start to use. But then I bump, as expected, into:
<pre class="theme:classic show-lang:2 wrap:true lang:default highlight:0 decode:true">CSP14304: Unknown source ''sha256-0ZMofb7eMqkB9IFHnGVZ6Z4chjplAavgi09shinNehs='' for directive 'script-src' in Content-Security-Policy - source will be ignored.</pre>
</li>
<li>Let's try Internet Explorer, version 11.0.10240.16431. I'll dump the entire console output to share this with you:
<pre class="theme:classic show-lang:2 wrap:true lang:default highlight:0 decode:true">Navigation occurred.
localhost:21275
test</pre>
<p>Amazing, no? Wait, let's try something else here. Let's remove the hash from the header, that should stop the script from running. I'll dump the console output again:</p>
<pre class="theme:classic show-lang:2 wrap:true lang:default highlight:0 decode:true">Navigation occurred.
localhost:21275
test</pre>
<p>So don't be fooled here. Internet Explorer doesn't support CSP v2, and even v1 is only partially supported.</li>
</ul>
<p>Let's try option 2 instead: making use of a nonce for every script block. This time, the results are looking a <em>little bit</em> better:</p>
<ul>
<li>Chrome is happily executing the script now.</li>
<li>So is Firefox, but Firefox keeps complaining about another script. I have no clue which one. I could try to find out, using the CSP reporting options, but I'm not going to bother.</li>
</ul>
<p>So there you have it: Content Security Policy is still not fully there yet. You can use it though, to restrict the use of other content, like webfonts, style sheets, media, ..., but for scripts our options are currently limited to either opening up 'unsafe-inline' or moving all JavaScript into files. And if you're doing ASP.NET projects, have a look at <a href="https://www.nuget.org/packages/NWebsec" target="_blank">https://www.nuget.org/packages/NWebsec</a>. This NuGet package will make implementing CSP - and other security headers - a <strong>lot</strong> easier for you :)</p>
